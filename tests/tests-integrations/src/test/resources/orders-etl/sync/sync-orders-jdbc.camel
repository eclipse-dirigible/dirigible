- route:
    id: orders-sync-route-jdbc
    description: Sync orders from OpenCart
    from:
      id: trigger-orders-replication-cron
      description: Trigger Orders Replication
      uri: cron
      parameters:
        schedule: 0/10 * * ? * *
        name: TriggerOrdersReplicationJDBC
      steps:
        - log:
            id: log-ac34
            description: Log starting
            message: Replicating orders from OpenCart using JDBC...
            loggingLevel: INFO
            logName: OpenCartOrdersReplication
        - setProperty:
            id: set-rate-property
            description: Set USD to EU exchange rate property
            name: currencyExchangeRate
            expression:
              simple:
                id: simple-7c58
                expression: '0.92'
        - setBody:
            id: create-order-select-statement
            description: Create orders SELECT statement
            expression:
              simple:
                id: simple-5db1
                expression: SELECT * FROM OC_ORDER
        - to:
            id: execute-get-orders
            description: Get all orders
            uri: spring-jdbc
            parameters:
              dataSourceName: DefaultDB
        - split:
            id: split-to-single-order
            description: Split to single order
            expression:
              simple:
                id: simple-ffe9
                expression: ${body}
            steps:
              - choice:
                  id: choose-database-syntax
                  description: Choose SQL syntax based on database
                  when:
                    - simple:
                        id: simple-8a2b
                        expression: ${header.CamelSpringJdbcDataSourceName} == 'DefaultDB'
                        steps:
                          - setBody:
                              id: create-order-merge-statement-h2
                              description: Create MERGE statement for H2
                              expression:
                                simple:
                                  id: simple-7d10
                                  expression: |
                                    MERGE INTO ORDERS
                                        (ID, TOTAL, DATEADDED)
                                    KEY(ID)
                                    VALUES
                                        (
                                            ${body['ORDER_ID']},
                                            ${body['TOTAL']} * ${exchangeProperty.currencyExchangeRate},
                                            '${body['DATE_ADDED']}'
                                        );
                          - to:
                              id: merge-order-h2
                              description: Merge order for H2
                              uri: spring-jdbc
                              parameters:
                                dataSourceName: DefaultDB
                    - simple:
                        id: simple-9c3d
                        expression: ${header.CamelSpringJdbcDataSourceName} == 'PostgreSQLDB'
                        steps:
                          - setBody:
                              id: create-order-merge-statement-postgres
                              description: Create INSERT ... ON CONFLICT statement for PostgreSQL
                              expression:
                                simple:
                                  id: simple-8e4f
                                  expression: |
                                    INSERT INTO ORDERS
                                        (ID, TOTAL, DATEADDED)
                                    VALUES
                                        (
                                            ${body['ORDER_ID']},
                                            ${body['TOTAL']} * ${exchangeProperty.currencyExchangeRate},
                                            '${body['DATE_ADDED']}'
                                        )
                                    ON CONFLICT (ID) DO UPDATE SET
                                        TOTAL = EXCLUDED.TOTAL,
                                        DATEADDED = EXCLUDED.DATEADDED;
                          - to:
                              id: merge-order-postgres
                              description: Merge order for PostgreSQL
                              uri: spring-jdbc
                              parameters:
                                dataSourceName: PostgreSQLDB
        - log:
            id: log-orders-replication-completed
            description: Log completed
            message: Successfully replicated orders from OpenCart using JDBC
            loggingLevel: INFO
            logName: OpenCartOrdersReplication
